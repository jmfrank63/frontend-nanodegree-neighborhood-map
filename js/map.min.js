"use strict";var map;$(function(){var a={lat:38.706495,lng:-9.156769};map=new GMaps({div:"#map-canvas",center:a,zoom:17})}());var foursquare=function(g,h){var b="https://api.foursquare.com/v2/venues/search";var f="0NF4PAQ2Q0HIF2XYTB5ICX135ZMSLYJXSSG0AMCFTMDA0M1G";var c="OJBZPIO4OQGKH3TP3BQUJJXCODPIVZAZEVMKLAWG1B1J2J5Z";var i="20150511";var e="38.706495,-9.156769";var a={client_id:f,client_secret:c,v:i,ll:e};var d=$.extend({},a,g);$.getJSON(b,d,h)};function markerViewModel(){var a=this;a.pool=[];a.lat=ko.observable(map.getCenter().A);a.lng=ko.observable(map.getCenter().F);a.address=ko.observable("");a.title=ko.observable("Neighborhood Map");a.keep=ko.observable(false);a.radius=ko.observable(200);a.limit=ko.observable(50);a.markers=ko.observableArray();a.search=ko.observable("");a.filter=ko.observable("");a.lng.subscribe(function(b){map.setCenter(a.lat(),a.lng())});a.lat.subscribe(function(b){map.setCenter(a.lat(),a.lng())});a.submitFilter=function(b){var d=[];var c=a.filter().split("|");a.markers([]);$.each(c,function(e,f){var g=false;if(f[0]==="!"){f=f.slice(1,f.length-1);g=true}$.extend(d,$.grep(a.pool,function(h){console.log(f.toLowerCase());return(h.name.toLowerCase().indexOf(f.toLowerCase())>-1)},g))});ko.utils.arrayPushAll(a.markers(),d);a.markers.valueHasMutated();a.drawMarkers(a.markers())};a.submitSearch=function(c){var b=map.getCenter();a.lat(b.A);a.lng(b.F);map.hideInfoWindows();var d=a.search().split("|");if(!a.keep()){a.markers([]);a.pool=[];map.removeMarkers()}$.each(d,function(e,f){foursquare({ll:a.lat()+","+a.lng(),query:f,radius:a.radius(),limit:a.limit()},a.getMarkers)})};a.getMarkers=function(b){if(b.meta.code!==200){console.log(a.title());return}a.title("Neighborhood Map");var f=b.response.venues;var c,d;var e=[];$.each(f,function(g,h){c=refineMarker(h);d=$.grep(a.markers(),function(i){return i.id===c.id});if(d.length==0){a.pool.push(c);e.push(c)}});ko.utils.arrayPushAll(a.markers(),e);a.markers.valueHasMutated();a.drawMarkers(a.markers())};a.drawMarkers=function(b){map.removeMarkers();$.each(b,function(c,d){map.addMarker(d.mapMarker)})};a.openInfoWindow=function(b){map.hideInfoWindows();(b.mapMarker.infoWindow).open(b.mapMarker.map,b.mapMarker)};a.geoLocate=function(){GMaps.geolocate({success:function(b){a.title("Neighborhood Map");a.lat(b.coords.latitude);a.lng(b.coords.longitude);map.setCenter(b.coords.latitude,b.coords.longitude)},error:function(b){a.title("Geolocation failed: "+b.message)},not_supported:function(){a.title("Your browser does not support geolocation")},always:function(){}})};a.geoCode=function(){GMaps.geocode({address:a.address(),callback:function(c,b){if(b=="OK"){a.title("Neighborhood Map");var d=c[0].geometry.location;map.setCenter(d.lat(),d.lng());a.lat(d.lat());a.lng(d.lng())}else{a.title("Address not found")}}})};$(".dropdown-menu input, .dropdown-menu label").click(function(b){b.stopPropagation()});$.each("PÃ©rola|Carris|bar".split("|"),function(b,c){foursquare({query:c,radius:200,limit:50},a.getMarkers)})}function refineMarker(b){var a={};a.visible=true;a.id=b.id;a.name=b.name;if(b.categories.length>0){a.category=b.categories[0].name}else{a.category=""}a.lat=b.location.lat;a.lng=b.location.lng;a.address=b.location.formattedAddress.join(", ");a.mapMarker=map.createMarker({lat:a.lat,lng:a.lng,title:a.name,infoWindow:{content:"<h3>"+a.name+"</h3><p>"+a.address+"</p>"}});return a}var mvm=new markerViewModel();ko.applyBindings(mvm);